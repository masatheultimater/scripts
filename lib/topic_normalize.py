"""トピック正規化ユーティリティ。

- TOPIC_MAP: problems_master.json 由来の 233 raw topic を正規化名へ変換する完全マップ
- normalize_topic(): 完全一致 -> 最長プレフィックス一致 -> 元値
- get_parent_category(): 正規化名から 15 カテゴリを返す（未該当は "その他"）
"""

from __future__ import annotations

PARENT_CATEGORIES = (
    "損金算入",
    "所得計算",
    "その他",
    "グループ法人",
    "益金不算入",
    "組織再編",
    "税額計算",
    "国際課税",
    "総則・定義",
    "欠損金",
    "申告納付等",
    "圧縮記帳等",
    "通算制度",
    "資本等取引",
    "引当金・準備金",
)

TOPIC_MAP: dict[str, str] = {
    'その他有価証券': '有価証券',
    'ないものとする金額': '譲渡損益調整資産',
    'みなし決済': '外貨建取引',
    'みなし配当': 'みなし配当',
    'みなし配当Ⅰ': 'みなし配当',
    'みなし配当Ⅱ': 'みなし配当',
    'みなし配当金（自己株式の取得）': 'みなし配当',
    'グループ法人税制': 'グループ法人税制',
    'デリバティブ取引': '外貨建取引',
    'デリバティブ取引に係るみなし決済': '外貨建取引',
    'リース取引': 'リース取引',
    'リース取引に係る所得の計算': 'リース取引',
    '一般社団法人・一般財団法人及び公益社団法人・公益財団法人に対する主な取扱い': '公益法人',
    '不正行為に係る費用の取扱い': '不正行為費用',
    '中小企業の会計に関する指針': '中小企業会計指針',
    '中小企業者等の判断': '中小企業者等判定',
    '中間申告': '中間申告',
    '事業年度': '事業年度',
    '交換差益の圧縮記帳': '交換差益',
    '交換差益金の圧縮記帳': '交換差益',
    '交際費等': '交際費等',
    '交際費等の損金不算入': '交際費等',
    '交際費等の損金不算入（交際費等と他の費用の区分）': '交際費等',
    '交際費等の損金不算入（原価算入交際費）': '交際費等',
    '交際費等の損金不算入（経理方法）': '交際費等',
    '仮装経理に基づく過大申告があった場合の取扱い': '仮装経理',
    '会社計算と税務計算の調整': '税務調整',
    '使用人給与': '使用人給与',
    '使用人給与の損金不算入 使用人賞与の損金算入時期': '使用人給与',
    '使途秘匿金': '使途秘匿金',
    '使途秘匿金の支出がある場合の課税の特例': '使途秘匿金',
    '保険差益': '保険差益',
    '保険差益の圧縮記帳・特別勘定': '保険差益',
    '保険差益の圧縮記帳（先行取得）': '保険差益',
    '保険差益の圧縮記帳（特別勘定設定後）': '保険差益',
    '保険差益金の額に対する課税の特例': '保険差益',
    '保険料': '保険料',
    '修正申告': '更正・修正申告',
    '借地権等の取扱い': '借地権',
    '債務免除等があった場合の欠損金の損金算入': '欠損金_債務免除',
    '償還差損益': '外貨建取引',
    '再生等欠損金': '欠損金_再生',
    '再計上の時期': '譲渡損益調整資産',
    '分割があった場合の主な取扱い': '分割',
    '分割型分割': '分割',
    '分割法人': '分割',
    '分社型分割': '分割',
    '判定': '中小企業者等判定',
    '別表一の作成': '別表一',
    '別表五㈠Ⅰ': '別表五(一)',
    '別表五㈠Ⅰの作成': '別表五(一)',
    '別表五㈠Ⅱ': '別表五(一)',
    '別表五㈠Ⅱの作成': '別表五(一)',
    '別表五㈡の作成': '別表五(二)',
    '別表五（一）': '別表五(一)',
    '別表四': '別表四',
    '別表四の作成': '別表四',
    '別表四及び別表五㈠の記載': '別表四',
    '収用等の圧縮記帳': '収用等',
    '収用等の圧縮記帳・特別勘定': '収用等',
    '収用等の圧縮記帳及び特別控除': '収用等',
    '収用等の圧縮記帳（特別勘定設定後）': '収用等',
    '収用等の場合の圧縮記帳及び特別勘定・収用換地等の所得の特別控除': '収用等',
    '収用等の特別控除': '収用等',
    '収益の額': '収益認識',
    '受取配当等': '受取配当等',
    '受取配当等の益金不算入': '受取配当等',
    '受取配当等の益金不算入額': '受取配当等',
    '受取配当等の益金不算入（控除負債利子）': '受取配当等',
    '受取配当等の益金不算入（特別分配金）': '受取配当等',
    '各事業年度の所得の金額の計算方法': '所得金額計算',
    '合併': '合併',
    '合併があった場合の主な取扱い': '合併',
    '合併法人（受取配当等・所得税額控除）': '合併',
    '合併法人（減価償却）': '合併',
    '合併法人（特別償却準備金）': '合併',
    '合併法人（貸倒引当金）': '合併',
    '同族会社の判定': '同族会社',
    '同族会社の意義 役員の意義 使用人兼務役員の意義': '同族会社',
    '同族判定及び役員等の判定': '同族会社',
    '国外関連取引': '移転価格税制',
    '国庫補助金の圧縮記帳（特別勘定設定後）': '国庫補助金等',
    '国庫補助金等': '国庫補助金等',
    '国庫補助金等に対する課税の特例': '国庫補助金等',
    '国庫補助金等の圧縮記帳・特別勘定': '国庫補助金等',
    '国庫補助金等の圧縮記帳（先行取得）': '国庫補助金等',
    '圧縮積立金': '圧縮記帳共通',
    '基本問題': '総合問題',
    '外国子会社から受ける配当等の益金不算入': '外国子会社配当',
    '外国子会社から受ける配当等の益金不算入（基本計算）': '外国子会社配当',
    '外国子会社合算税制': '外国子会社合算税制',
    '外国税額控除': '外国税額控除',
    '外国税額控除と外国子会社配当等': '外国税額控除',
    '外貨建取引': '外貨建取引',
    '外貨建取引の換算、換算方法及び換算差損益の取扱い': '外貨建取引',
    '大法人による完全支配関係等の判断': '中小企業者等判定',
    '完全支配関係がある法人間取引の損益の調整': '完全支配関係',
    '完全支配関係の判定': '完全支配関係',
    '寄附修正': '寄附修正',
    '寄附金の損金不算入': '寄附金',
    '寄附金の損金不算入（経理方法）': '寄附金',
    '寄附金の額と繰延資産の判断': '寄附金',
    '寄附金・受贈益': '寄附修正',
    '寄附金・受贈益・寄附修正': '寄附修正',
    '少額の減価償却資産 一括償却資産 中小企業者等の特例': '減価償却',
    '工事の請負に係る収益及び費用の帰属事業年度の特例': '工事進行基準',
    '工事進行基準（まとめ問題）': '工事進行基準',
    '工事進行基準（コメント問題）': '工事進行基準',
    '工事進行基準（一括評価金銭債権）': '貸倒引当金_一括',
    '工事進行基準（基本問題）': '工事進行基準',
    '工事進行基準（確定決算型）': '工事進行基準',
    '工事進行基準（計算パターン）': '工事進行基準',
    '工事進行基準（過去試験問題）': '工事進行基準',
    '帰属事業年度': '税務調整',
    '役員・使用人兼務役員の判定': '役員給与',
    '役員判定': '役員給与',
    '役員給与': '役員給与',
    '役員給与の損金不算入I': '役員給与',
    '役員給与の損金不算入II': '役員給与',
    '役員給与・特殊関係使用人給与（基本計算）': '役員給与',
    '役員給与（給与改定）': '役員給与',
    '役員給与（退職給与）': '役員給与',
    '所得の帰属に関する通則': '所得の帰属',
    '所得税額控除': '所得税額控除',
    '控除対象外消費税額等': '控除対象外消費税額等',
    '控除対象外消費税額等と他規定との関係': '控除対象外消費税額等',
    '控除対象外消費税額等の取扱い': '控除対象外消費税額等',
    '損金の額': '所得金額計算',
    '新株予約権を対価とする費用の帰属事業年度の特例': '費用帰属特例',
    '更正の請求及び修正申告 更正又は決定': '更正・修正申告',
    '有価証券': '有価証券',
    '有価証券の意義及び取得価額': '有価証券',
    '有価証券の期末評価及び売買目的有価証券の意義': '有価証券',
    '有価証券・固定資産': '有価証券',
    '有価証券（取得価額）': '有価証券',
    '有価証券（期末評価）': '有価証券',
    '有価証券（譲渡原価）': '有価証券',
    '未処理': '総合問題',
    '株式交換等があった場合の主な取扱い': '株式交換等',
    '株式分配があった場合の主な取扱い': '株式交換等',
    '棚卸資産': '棚卸資産',
    '棚卸資産の評価方法': '棚卸資産',
    '欠損等法人の取扱い': '欠損金_欠損等法人',
    '欠損金の繰戻しによる還付': '欠損金_繰戻還付',
    '欠損金の繰越し': '欠損金_繰越控除',
    '欠損金の繰越控除': '欠損金_繰越控除',
    '欠損金（欠損金の繰戻しによる還付）': '欠損金_繰戻還付',
    '欠損金（欠損金の繰越控除）': '欠損金_繰越控除',
    '残余財産が確定した場合の欠損金の取扱い': '欠損金_残余財産',
    '法人による完全支配関係の判定': '完全支配関係',
    '法人税総合問題': '総合問題',
    '法人税総合計算': '総合問題',
    '法人課税信託': '法人課税信託',
    '消費税の経理方法': '消費税・解法パターン',
    '消費税の記載': '消費税・解法パターン',
    '減価償却': '減価償却',
    '減価償却と圧縮記帳との関係': '圧縮記帳共通',
    '減価償却資産の意義及び取得価額': '減価償却',
    '減価償却（償却限度額の特例）': '減価償却',
    '減価償却（少額、一括、中小特例）': '減価償却',
    '減価償却（特別償却準備金）': '減価償却',
    '減価償却（資本的支出と修繕費）': '減価償却',
    '減損損失': '評価損益',
    '為替予約': '外貨建取引',
    '特別償却・特別控除': '特別償却',
    '特別償却準備金': '特別償却',
    '特定資産の買換えの圧縮記帳・特別勘定': '買換え',
    '特定資産の買換えの圧縮記帳（先行取得）': '買換え',
    '特定資産の買換えの圧縮記帳（特別勘定設定後）': '買換え',
    '特定資産の買換えの場合の課税の特例': '買換え',
    '特定資産譲渡等損失': '特定資産譲渡等損失',
    '特殊関係使用人給与': '役員給与',
    '現物出資があった場合の主な取扱い': '現物出資',
    '留保金課税': '留保金課税',
    '短期売買商品等の期末評価、短期売買商品等の意義及び取得価額': '有価証券',
    '短期売買商品等の譲渡損益及び算出方法': '有価証券',
    '短期所有株式等と所得税額控除': '所得税額控除',
    '短期所有株式等の算出': '所得税額控除',
    '短期所有株式等（非支配目的株式等）': '所得税額控除',
    '確定決算型': '消費税・解法パターン',
    '確定申告': '確定申告',
    '租税公課等及び納税充当金': '租税公課等',
    '租税公課等及び納税充当金（経理方法）': '租税公課等',
    '租税公課等及び納税充当金（過大引当・引当不足、還付税金）': '租税公課等',
    '移転価格税制': '移転価格税制',
    '税効果会計': '税効果会計',
    '税務調整': '税務調整',
    '精算表型': '消費税・解法パターン',
    '納税地': '納税地',
    '納税義務者 課税所得等の範囲': '納税義務者',
    '総合問題': '総合問題',
    '総合問題Ⅰ': '総合問題',
    '総合問題Ⅱ': '総合問題',
    '総合問題Ⅲ': '総合問題',
    '総合問題Ⅳ': '総合問題',
    '繰延資産': '繰延資産',
    '繰延資産の意義及び償却計算': '繰延資産',
    '被合併法人から合併法人': '合併',
    '被合併法人（減価償却Ⅰ）': '合併',
    '被合併法人（減価償却Ⅱ）': '合併',
    '解散があった場合の欠損金の損金算入': '欠損金_解散',
    '解散税制': '欠損金_解散',
    '設立事業年度': '事業年度',
    '評価損益': '評価損益',
    '評価損計上事由': '評価損益',
    '認容': '総合問題',
    '譲渡制限付株式を対価とする費用の帰属事業年度の特例': '費用帰属特例',
    '譲渡損益調整資産の低額譲渡': '譲渡損益調整資産',
    '譲渡損益調整資産の判定': '譲渡損益調整資産',
    '買換え': '買換え',
    '貸倒引当金': '貸倒引当金',
    '貸倒引当金（一括評価）': '貸倒引当金_一括',
    '貸倒引当金（個別評価）': '貸倒引当金_個別',
    '貸倒損失': '貸倒損失',
    '資本等取引（自己株式の消却・譲渡）': '資本等取引',
    '資本等取引（計数変動、自己株式の取得）': '資本等取引',
    '資本金等の額 利益積立金額': '資本金等の額',
    '資産の評価損益': '評価損益',
    '資産等に係る調整勘定の取扱い': '調整勘定',
    '通算制度': '通算制度',
    '過去試験問題': '総合問題',
    '過大支払利子税制': '過大支払利子税制',
    '過少資本税制': '過少資本税制',
    '適格判定': '適格判定',
    '適格現物分配': '適格現物分配',
    '適格現物分配があった場合の主な取扱い': '適格現物分配',
    '適格組織再編があった場合の欠損金等の取扱い': '組織再編_欠損金',
    '還付税金（未収金経理）': '租税公課等',
    '配当等の区分': '受取配当等',
    '配当等の額とみなす金額': 'みなし配当',
    '隣接費用の判断': '隣接費用',
    '青色申告': '青色申告',
    'Ｐ/Ｌ修正型': '消費税・解法パターン',
}

PREFIX_MAP: tuple[tuple[str, str], ...] = tuple(
    sorted(
        [
            ("減価償却", "減価償却"),
            ("交際費等", "交際費等"),
            ("役員給与", "役員給与"),
            ("繰延資産", "繰延資産"),
            ("寄附金の損金不算入", "寄附金"),
            ("使用人給与", "使用人給与"),
            ("控除対象外消費税額等", "控除対象外消費税額等"),
            ("新株予約権を対価とする費用", "費用帰属特例"),
            ("譲渡制限付株式を対価とする費用", "費用帰属特例"),
            ("リース取引", "リース取引"),
            ("受取配当等", "受取配当等"),
            ("外国子会社から受ける配当等", "外国子会社配当"),
            ("別表四", "別表四"),
            ("別表五㈠Ⅰ", "別表五(一)"),
            ("別表五㈠Ⅱ", "別表五(一)"),
            ("租税公課等及び納税充当金", "租税公課等"),
            ("工事進行基準", "工事進行基準"),
            ("有価証券", "有価証券"),
            ("短期売買商品等", "有価証券"),
            ("棚卸資産", "棚卸資産"),
            ("消費税", "消費税・解法パターン"),
            ("外貨建取引", "外貨建取引"),
            ("デリバティブ取引", "外貨建取引"),
            ("総合問題", "総合問題"),
            ("完全支配関係", "完全支配関係"),
            ("寄附金・受贈益", "寄附修正"),
            ("譲渡損益調整資産", "譲渡損益調整資産"),
            ("国庫補助金等", "国庫補助金等"),
            ("国庫補助金の圧縮記帳", "国庫補助金等"),
            ("保険差益", "保険差益"),
            ("収用等", "収用等"),
            ("交換差益金", "交換差益"),
            ("交換差益", "交換差益"),
            ("特定資産の買換え", "買換え"),
            ("短期所有株式等", "所得税額控除"),
            ("外国税額控除", "外国税額控除"),
            ("使途秘匿金", "使途秘匿金"),
            ("合併", "合併"),
            ("被合併法人", "合併"),
            ("合併法人", "合併"),
            ("分割", "分割"),
            ("分社型分割", "分割"),
            ("分割法人", "分割"),
            ("適格現物分配", "適格現物分配"),
            ("株式交換等", "株式交換等"),
            ("株式分配", "株式交換等"),
            ("資本等取引", "資本等取引"),
            ("みなし配当金", "みなし配当"),
            ("みなし配当", "みなし配当"),
            ("同族会社", "同族会社"),
            ("同族判定", "同族会社"),
        ],
        key=lambda x: len(x[0]),
        reverse=True,
    )
)

CATEGORY_MAP: dict[str, str] = {
    # 損金算入
    "減価償却": "損金算入",
    "交際費等": "損金算入",
    "役員給与": "損金算入",
    "繰延資産": "損金算入",
    "寄附金": "損金算入",
    "使用人給与": "損金算入",
    "貸倒損失": "損金算入",
    "控除対象外消費税額等": "損金算入",
    "不正行為費用": "損金算入",
    "保険料": "損金算入",
    "借地権": "損金算入",
    "費用帰属特例": "損金算入",
    "リース取引": "損金算入",
    "隣接費用": "損金算入",
    # 益金不算入
    "受取配当等": "益金不算入",
    "外国子会社配当": "益金不算入",
    # 所得計算
    "別表四": "所得計算",
    "別表五(一)": "所得計算",
    "別表五(二)": "所得計算",
    "別表一": "所得計算",
    "租税公課等": "所得計算",
    "税効果会計": "所得計算",
    "収益認識": "所得計算",
    "工事進行基準": "所得計算",
    "有価証券": "所得計算",
    "棚卸資産": "所得計算",
    "消費税・解法パターン": "所得計算",
    "税務調整": "所得計算",
    "外貨建取引": "所得計算",
    "評価損益": "所得計算",
    "総合問題": "所得計算",
    # グループ法人
    "グループ法人税制": "グループ法人",
    "完全支配関係": "グループ法人",
    "寄附修正": "グループ法人",
    "譲渡損益調整資産": "グループ法人",
    "中小企業者等判定": "グループ法人",
    # 圧縮記帳等
    "国庫補助金等": "圧縮記帳等",
    "保険差益": "圧縮記帳等",
    "収用等": "圧縮記帳等",
    "交換差益": "圧縮記帳等",
    "買換え": "圧縮記帳等",
    "圧縮記帳共通": "圧縮記帳等",
    "特別償却": "圧縮記帳等",
    # 税額計算
    "所得税額控除": "税額計算",
    "外国税額控除": "税額計算",
    "留保金課税": "税額計算",
    "使途秘匿金": "税額計算",
    # 組織再編
    "合併": "組織再編",
    "分割": "組織再編",
    "適格現物分配": "組織再編",
    "現物出資": "組織再編",
    "株式交換等": "組織再編",
    "組織再編_欠損金": "組織再編",
    "適格判定": "組織再編",
    "調整勘定": "組織再編",
    "特定資産譲渡等損失": "組織再編",
    # 欠損金
    "欠損金_繰越控除": "欠損金",
    "欠損金_繰戻還付": "欠損金",
    "欠損金_債務免除": "欠損金",
    "欠損金_解散": "欠損金",
    "欠損金_欠損等法人": "欠損金",
    "欠損金_残余財産": "欠損金",
    "欠損金_再生": "欠損金",
    # 資本等取引
    "資本金等の額": "資本等取引",
    "資本等取引": "資本等取引",
    "みなし配当": "資本等取引",
    # 総則・定義
    "納税義務者": "総則・定義",
    "事業年度": "総則・定義",
    "納税地": "総則・定義",
    "所得の帰属": "総則・定義",
    "所得金額計算": "総則・定義",
    "同族会社": "総則・定義",
    "法人課税信託": "総則・定義",
    "中小企業会計指針": "総則・定義",
    "公益法人": "総則・定義",
    # 申告納付等
    "確定申告": "申告納付等",
    "中間申告": "申告納付等",
    "青色申告": "申告納付等",
    "更正・修正申告": "申告納付等",
    "仮装経理": "申告納付等",
    # 国際課税
    "移転価格税制": "国際課税",
    "過少資本税制": "国際課税",
    "過大支払利子税制": "国際課税",
    "外国子会社合算税制": "国際課税",
    # 引当金・準備金
    "貸倒引当金_一括": "引当金・準備金",
    "貸倒引当金_個別": "引当金・準備金",
    "貸倒引当金": "引当金・準備金",
    # 通算制度
    "通算制度": "通算制度",
}


def normalize_topic(topic: str) -> str:
    """raw topic 名を正規化する。"""
    if topic in TOPIC_MAP:
        return TOPIC_MAP[topic]

    for prefix, normalized in PREFIX_MAP:
        if topic.startswith(prefix):
            return normalized

    return topic


def get_parent_category(topic_or_normalized: str) -> str:
    """トピック名（raw/normalized）に対する親カテゴリを返す。"""
    normalized = normalize_topic(topic_or_normalized)
    return CATEGORY_MAP.get(normalized, "その他")
