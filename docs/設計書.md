# 法人税法 学習システム 設計書

> **目的**: このドキュメントは、ししゃも（吉川昌宏）が設計した法人税法の学習システムの全体像をまとめたものである。次の会話でシステム構築を継続するための引き継ぎ資料として使用する。

---

## 1. システム概要

### コンセプト
- 法人税法の「計算」と「理論」の学習を、複数のAIツール + Obsidian + Anki + 自作アプリ（コメコメ暗記）で統合的に支援するシステム
- **紙での学習（ルーズリーフ・手書き）は従来通り維持**し、その前後をAIで自動化する
- WSL2内で中核の自動化処理を完結させる
- 廣升先生のコメコメ暗記法をデジタル化し、iPhoneで使えるPWAアプリとして実装済み

### 設計原則
- **データ駆動**: Obsidian Vaultの `10_論点/` のfrontmatterが全自動化の基盤（データベースのカラム相当）
- **Gemini→Claude 2段階処理**: Gemini CLIがPDF全体の構造分析（森を見る）、Claude Codeが個別ノート生成（木を見る）
- **手動ステップの最小化**: 手動で残る作業は「PDFを置く」「紙で解く」「結果をコマンド入力」「ChatGPTで口頭練習」「週1回NotebookLMアップロード」のみ

---

## 2. ツール構成と役割分担

### 中核ツール（毎日使う）

| ツール | 役割 | 実行環境 |
|---|---|---|
| **Obsidian Vault** | データハブ。知識の構造化・全体管理・結果蓄積。全データの唯一の正規ソース | Windows（VaultはWSL2側に配置） |
| **コメコメ暗記アプリ** | 演習エンジン。廣升式コメコメ暗記法のロジック実行。セッション中の出題制御・コメ管理・短期復習スケジュール（3/7/14/28日） | iPhone（PWA） |
| **Claude Code** | 自動化エンジン。ノート整形・問題生成・結果分析・各ツール間のデータ変換 | WSL2 |

### 補助ツール

| ツール | 役割 | 実行環境 |
|---|---|---|
| **Gemini CLI** | PDF全体の構造分析（長コンテキスト活用）、論点カバレッジの横断チェック、税制改正キャッチアップ | WSL2 |
| **Anki** | コメコメ卒業後（28日サイクル完了）の長期記憶維持。条文番号等の単純暗記。スキマ時間にスマホでめくる | iPhone/PC |
| **ChatGPT Voice** | 理論の口頭アウトプット練習。試験委員ロールプレイで回答を採点 | iPhone |
| **NotebookLM** | 音声学習コンテンツ生成（ポッドキャスト形式）。通勤中の聞き流し復習 | ブラウザ |
| **cron (WSL2)** | 定期実行エンジン。毎朝の問題生成、週次レポート等をバックグラウンドで実行 | WSL2 |

### コメコメ vs Anki の使い分け

| | コメコメ暗記 | Anki |
|---|---|---|
| 対象 | 理論の穴埋め・正誤、計算の判断問題 | 28日卒業後の長期維持、条文番号・定義の丸暗記 |
| 学習スタイル | セッション型（集中学習） | スキマ時間型（ちょい復習） |
| 復習管理 | 3→7→14→28日の4段階 | SRSアルゴリズム（無期限） |
| コメ管理 | あり（累積、永久に残る） | なし |

---

## 3. コメコメ暗記法のロジック（実装済み）

### 廣升先生のメソッド
1. 問題を解く → **不正解ならコメ1本**（累積、永久に減らない）
2. 違う問題を3〜4問進めてから、その問題に戻る
3. 再挑戦 → 不正解ならコメ追加、正解ならスルーして次へ
4. **セッション中にコメ4本到達で今日は完成**
5. **正解でスルーした問題も、3日後・7日後・14日後・28日後に再出題**
6. 復習時に不正解なら、再びコメ4本サイクル開始（コメは累積加算）
7. 28日後の復習も完了 → 卒業（Ankiに移行）

### 実装上のデータ構造
- `komeTotal`: 累積コメ数（永久に減らない。全履歴を通じた苦手度の指標）
- `sessionKome`: セッション中の4本サイクル管理用（セッションごとにリセット）
- `intervalIndex`: 現在の復習ステージ（0=初回, 1=3日後, 2=7日後, 3=14日後, 4=28日後, 5=卒業）
- `history[]`: 全回答履歴（日付・結果・累積コメ数を記録）
- `graduated`: 卒業フラグ

### コメコメアプリの機能（v2 実装済み）
- セッション中の出題制御（不正解→3問後に再出題）
- 累積コメ表示 + セッション内サイクル表示（今回 0/4）
- デッキ分け（論点別に整理可能）
- 個別追加・一括追加（TABまたは `|` 区切り）
- 問題の編集・削除
- 各問題の解答履歴閲覧（コメ推移グラフ付き）
- Obsidian Markdownエクスポート（サマリー・デッキ別統計・問題別コメ経過）
- 永続化ストレージ（`window.storage` API使用）

---

## 4. 勉強法とツールの対応

| 勉強法 | メインツール | AI補助 |
|---|---|---|
| 計算を紙に書く | ルーズリーフ（従来通り） | Obsidianに結果記録 → 弱点分析 |
| 口に出す | ChatGPT Voice | Ankiで暗唱テーマを管理 |
| 書いて覚える | 紙（従来通り） | Claude Codeで書く前の骨格整理 |
| 見て覚える | Anki + NotebookLM音声 | スキマ時間にカード＆音声 |
| 頭で暗唱する | Anki + コメコメ | 穴埋め・段階展開カード |

---

## 5. Obsidian Vault 設計

### フォルダ構成

```
vault/
├── 00_inbox/              # テキストメモ投入口（雑メモ → Claude Codeが自動整形・振り分け）
├── 01_sources/            # PDF原本の倉庫（読み取り専用）
│   ├── 大原/
│   │   ├── 計算テキスト①〜④.pdf
│   │   ├── 計算問題集①〜④.pdf
│   │   ├── 確認テスト_01〜07.pdf
│   │   ├── 模試_01〜07.pdf
│   │   ├── 理論テキスト.pdf
│   │   └── 理論問題集.pdf
│   ├── TAC/
│   │   ├── 計算_個別.pdf
│   │   ├── 計算_応用.pdf
│   │   ├── 理論_基礎.pdf
│   │   └── 過去問題集.pdf
│   ├── 法令/
│   │   ├── 法人税法.pdf
│   │   ├── 施行令.pdf
│   │   ├── 基本通達.pdf
│   │   └── 措置法.pdf
│   ├── 実務書/
│   └── _index.json         # 取り込み済み管理（二重処理防止）
├── 02_extracted/           # Gemini CLIが生成する中間データ
│   ├── *_structure.md      # 教材の全体構造・章立て・論点マップ
│   └── *_topics.json       # 論点リスト（Claude Codeへの指示書）
├── 10_論点/                # 【中核】正規データ（1論点 = 1ノート）
│   ├── 所得計算/
│   ├── 損金算入/           # 減価償却、繰延資産、引当金 etc.
│   ├── 益金不算入/         # 受取配当、外国子会社 etc.
│   ├── 税額計算/           # 税額控除、同族会社 etc.
│   ├── グループ法人/
│   ├── 組織再編/
│   ├── 国際課税/
│   └── その他/
├── 20_演習ログ/            # 追記専用（append-only）
│   ├── komekome/           # コメコメセッション結果（日次・自動書き込み）
│   └── 計算演習/           # logコマンド結果（日次・自動書き込み）
├── 30_ソース別/            # 教材→論点のインデックス（PDF取り込み時に自動生成）
│   ├── 大原/               # 問題番号 → 論点ノートへのリンク
│   ├── TAC/
│   └── 法令/               # 条文番号 → 論点リンク
├── 40_分析/                # 自動生成レポート（手動編集しない）
│   ├── 週次レポート/
│   ├── 弱点分析/
│   └── カバレッジ/
├── 50_エクスポート/        # 外部ツール向け出力（自動生成）
│   ├── notebooklm_理論.md
│   ├── notebooklm_計算.md
│   ├── .notebooklm_hash    # SHA-256差分検出用ハッシュ
│   ├── anki_exported.json   # Ankiエクスポート済み管理
│   └── komekome_import.json
├── 90_テンプレート/        # Templater用テンプレート
└── 99_ダッシュボード.md    # Dataviewで全データを集約表示
```

### 設計原則
1. `10_論点/` が唯一の正規データソース。他は全てここを参照する
2. frontmatter がデータベースのカラム。Dataview・Claude Code・コメコメが全てここを読み書きする
3. `00_inbox/` に入れるだけ → 自動で整形・分類・リンク付与
4. `01_sources/` にPDFを置くだけ → Gemini→Claudeで自動抽出
5. `20_演習ログ/` は追記専用（append-only）。ログは改変しない
6. `30_ソース別/` は教材→論点のインデックス。本文は `10_論点/` にある
7. `40_分析/` と `50_エクスポート/` は全て自動生成。手動編集しない

### 論点ノートの frontmatter スキーマ

```yaml
---
topic: "減価償却_普通"           # 論点ID
category: "損金算入"             # 大分類
subcategory: "減価償却"          # 中分類
type: [理論, 計算]               # 理論/計算/両方
importance: "A"                  # 重要度 A/B/C（出題頻度から自動判定）
conditions: [法31, 令48]         # 関連条文（法令PDFから自動抽出）
sources:                         # この論点が登場する教材（PDF取り込み時に自動追記）
  - "大原計テ①-Ch3"
  - "TAC個別-Q12"
keywords: ["耐用年数", "残存価額", "定額法"]  # 暗記キーワード（理論PDFから自動抽出）
related: ["減価償却_特別", "圧縮記帳"]        # 関連論点（Gemini構造分析で自動設定）
kome_total: 7                    # 累積コメ数（自動更新）
calc_correct: 5                  # 計算 正解数（自動更新）
calc_wrong: 3                    # 計算 不正解数（自動更新）
last_practiced: 2026-02-17       # 最終演習日（自動更新）
stage: "復習中"                  # 学習進捗ステージ（komekome_writeback.sh, log.sh が更新）
                                 #   値: 未着手 / 学習中 / 復習中 / 卒業済
status: "学習中"                 # ライフサイクル状態（komekome_writeback.sh が更新）
                                 #   値: 未着手 / 学習中 / 復習中 / 卒業
                                 #   卒業条件: status="復習中" + gap≥25日 + kome_total≥4 + 正解
pdf_refs:                        # PDF原本の該当ページ（Obsidianで直接開ける）
  - "01_sources/大原/計算テキスト①.pdf#page=45"
mistakes: ["別表四の方向を間違えた"]  # 間違えた理由（自動+手動）
extracted_from: "Gemini 2026-02-17"   # どのAIがいつ生成したか
---
```

### frontmatter フィールドの更新責務

| フィールド | 更新するスクリプト | 備考 |
|-----------|-------------------|------|
| kome_total | komekome_writeback.sh | コメ数を累積加算 |
| calc_correct / calc_wrong | log.sh | 計算演習の正誤カウント |
| last_practiced | komekome_writeback.sh, log.sh | 最終演習日 |
| stage | komekome_writeback.sh, log.sh | 学習進捗（卒業済みノートは更新しない） |
| status | komekome_writeback.sh | ライフサイクル状態（卒業判定を含む） |
| mistakes | komekome_writeback.sh, log.sh | 間違えた理由を追記 |

> **重要**: `status == "卒業"` のノートは log.sh で stage/status を巻き戻さない。
> generate_quiz.sh は `status == "卒業"` のノートを出題候補から除外する。

### 演習ログの frontmatter スキーマ

```yaml
---
date: 2026-02-17
session_type: "komekome"      # komekome / calc / oral
total_problems: 25
correct: 18
wrong: 7
kome_added: 7                 # 追加されたコメ数
cycle_completed: 2            # コメ4本完成した問題数
weak_topics: ["減価償却_特別", "圧縮記帳"]  # 不正解だった論点
duration_min: 45
---
```

### ソースマップの frontmatter スキーマ

```yaml
---
source_name: "大原 計算問題集①"
source_type: "計算問題集"     # テキスト/問題集/模試/法令 etc.
publisher: "大原"
total_problems: 120
covered: 85                   # 着手済み問題数（自動更新）
---
```

### 主要 Dataview クエリ（99_ダッシュボード.md 用）

```dataview
// 今日の弱点トップ10
TABLE kome_total as "コメ", calc_wrong as "×", last_practiced as "最終", stage as "ステージ"
FROM "10_論点"
WHERE status != "卒業"
SORT kome_total DESC
LIMIT 10
```

```dataview
// 未着手の論点
LIST FROM "10_論点" WHERE status = "未着手" SORT importance ASC
```

```dataview
// 教材カバー率
TABLE source_type as "種別", covered + "/" + total_problems as "進捗", round(covered/total_problems*100) + "%" as "率"
FROM "30_ソース別" SORT source_type
```

```dataview
// 直近7日の演習サマリー
TABLE correct + "/" + total_problems as "正答", kome_added as "+コメ", duration_min + "分" as "時間"
FROM "20_演習ログ" WHERE date >= date(today) - dur(7 days) SORT date DESC
```

```dataview
// コメ数ランキング（苦手論点）
TABLE kome_total as "累積コメ", category as "分類", stage as "ステージ"
FROM "10_論点" WHERE kome_total > 0 SORT kome_total DESC
```

---

## 6. PDF取り込みパイプライン

### 4ステージ処理

```
STAGE 0 (手動)     : PDFを 01_sources/ に置く
STAGE 1 (Gemini)   : PDF全体の構造分析 → 02_extracted/ に中間データ出力
STAGE 2 (Claude)   : 中間データから 10_論点/ と 30_ソース別/ のノートを生成・更新
STAGE 3 (Gemini→Claude) : 横断チェック → 抜け漏れ検出 → 修正
```

### STAGE 1: Gemini CLI の処理

```bash
gemini -f 01_sources/大原/計算テキスト①.pdf \
  "この法人税法の計算テキストの全体構造を分析して。
   以下を出力:
   1. 章・節の階層構造(markdown)
   2. 各節に含まれる論点リスト(JSON)
      各論点: {topic_id, name, category, subcategory,
               conditions:[], page_range, problem_numbers:[]}
   3. 他教材との重複がありそうな論点の推定"
```

出力: `02_extracted/大原_計算テキスト①_structure.md` + `_topics.json`

### STAGE 2: Claude Code の処理

```bash
claude -p "02_extracted/大原_計算テキスト①_topics.json を読み、
  各論点について:
  1. 10_論点/ に該当ノートがなければテンプレートで新規作成
  2. 既にあれば sources に '大原計テ①-Ch3' を追加
  3. 30_ソース別/大原/計算テキスト①.md にマッピング追記
  frontmatterの全フィールドを埋めること"
```

### Gemini と Claude の役割分担の理由

| | Gemini CLI | Claude Code |
|---|---|---|
| 強み | 100万トークンで教材全体を一気に読める | ファイル操作とMarkdown生成の精度が高い |
| 役割 | 「森を見る」— 全体構造・教材間の重複・体系の整合性 | 「木を見る」— 個別ノートの正確な生成・既存ノートとの整合性 |
| 実行タイミング | PDF投入時 + 週次チェック | PDF投入時 + 毎日の定期処理 |

### 教材タイプ別の処理方針

| 教材タイプ | Geminiの仕事 | Claudeの仕事 |
|---|---|---|
| 計算テキスト | 全体の体系図、章間の依存関係 | 各論点の計算手順をステップ形式で記載 |
| 計算問題集 | 全問題の論点分類、教材間グルーピング | 判断ポイント抽出→コメコメカード化 |
| 理論テキスト | 理論体系の全体マップ、核キーワード抽出 | 柱書き・キーワード・暗記ポイントの個別記載 |
| 確認テスト/模試/過去問 | 出題頻度ランキング、傾向変化分析 | 各問題を論点ノートに紐付け、重要度更新 |
| 法令・通達 | 条文間のリンク構造、委任先追跡 | conditions フィールドの正確な充填、条文要約 |

---

## 7. データフロー

### コアループ（毎日自動で回る）

```
Obsidian(論点データ) → Claude Code(問題生成) → コメコメ(演習実行) → Claude Code(結果分析) → Obsidian(記録蓄積)
```

### イベント別の更新フロー

#### コメコメ セッション終了時
1. コメコメ → JSON結果を出力
2. Claude Code → `20_演習ログ/komekome/` にセッションログ.md を自動作成
3. Claude Code → `10_論点/` の該当ノートのfrontmatterを更新（kome_total, last_practiced, stage, mistakes）
4. Claude Code → `50_エクスポート/komekome_import.json` を翌日分に更新

#### log コマンド実行時（計算演習後）
1. `log 減価償却 3-2 ×` → シェルスクリプトがClaude Codeを呼び出し
2. Claude Code → `20_演習ログ/計算演習/` に追記
3. Claude Code → `10_論点/` の該当ノートの `calc_correct/calc_wrong` を更新
4. Claude Code → `30_ソース別/` の該当教材の `covered` を更新

#### 毎朝 cron（7:00）
1. `generate_quiz.sh` → `10_論点/` を走査、復習対象を抽出（卒業済み除外）
2. `generate_quiz.sh` → `50_エクスポート/komekome_import.json` に今日の出題を書き出し

#### 毎週日曜 cron（6:00-6:30）
1. `weekly_report.sh` → `40_分析/週次レポート/` に週次サマリー生成
2. `coverage_analysis.sh` → `40_分析/カバレッジ/` にレポート生成
3. `notebooklm_export.sh` → `50_エクスポート/notebooklm_*.md` を更新（差分検出付き）

#### 手動実行
1. `anki_export.sh` → 卒業論点を AnkiConnect API 経由で Anki に追加
2. `komekome_writeback.sh` → コメコメ結果を論点ノートに書き戻し（卒業判定含む）

### 問題カードのライフサイクル

```
誕生（Claude Codeが論点ノートから自動生成）
  → 学習（コメコメでコメ4本サイクル実行）
  → 復習（3→7→14→28日後にコメコメで再出題）
  → 卒業（28日サイクル完了 → Ankiに移行して長期維持）
  → 分析（結果がObsidianに蓄積、次の問題生成に反映）
```

---

## 8. Daily Flow

| 時間帯 | やること | ツール | 自動/手動 |
|---|---|---|---|
| AM 7:00 | cron → Claude Codeが今日の出題リスト生成 | cron + Claude Code | 自動 |
| 通勤 | Ankiでカード復習 + NotebookLM音声で聞き流し | Anki + NotebookLM | 手動 |
| 昼休み | ChatGPT Voice で理論の口頭練習 10分 | ChatGPT | 手動 |
| 夜 演習 | 大原の問題を紙で解く → `log` コマンドで結果記録 | 紙 + ターミナル | 手動 |
| 夜 コメコメ | iPhoneでコメコメアプリを開いて演習 | コメコメ | 手動 |
| 夜 整理 | メモをVaultに → Claude Code が自動整形+カード生成 | Claude Code | 自動 |
| 週末 | Gemini CLI で論点カバレッジチェック → 翌週計画 | Gemini CLI | 自動 |

---

## 9. 教材ソース一覧

### 大原
- 計算テキスト ×4
- 計算問題集 ×4
- (月例)確認テスト ×7
- 模試 ×7ほど
- 理論テキスト
- 理論問題集

### TAC（市販）
- 計算問題集（個別論点）
- 理論問題集（基礎）
- 計算問題集（応用）
- 過去問題集

### 法令・通達
- 法人税法
- 法人税法施行令・施行規則
- 法人税基本通達
- 租税特別措置法（法人税関連）

### その他
- 市販の実務書
- 国税庁の質疑応答事例（検討中）
- 税制改正の大綱・改正法の概要（検討中）

---

## 10. 技術環境

- **WSL2 (Ubuntu)**: 中核の自動化処理を実行。Claude Code・Gemini CLI インストール済み
- **Obsidian**: Windows側で動作。VaultはWSL2側に配置し `\\wsl$\Ubuntu\home\...` でアクセス
- **cron**: WSL2のcronで定期実行
- **コメコメアプリ**: Claude Artifactで実装済み（React JSX）。`window.storage` APIで永続化
- **.wslconfig**: メモリ上限を明示的に設定（過去にメモリ問題あり）

---

## 11. 実装済みアーティファクト

以下のReact JSXアーティファクトが作成済み:

1. **system-v3.jsx** — システム全体の構成図・データフロー・ツール役割分担
2. **komekome-v2.jsx** — コメコメ暗記アプリ本体（コメ累積・復習スケジュール・Obsidianエクスポート・履歴閲覧）
3. **vault-design-v2.jsx** — Vault設計（フォルダ構成・PDF取り込みパイプライン・frontmatterスキーマ・Dataviewクエリ）
4. **study-flow.jsx** — 計算/理論の学習フロー詳細

---

## 12. 実装状況

### Phase 1: Vault の土台 ✅
- [x] Obsidian Vaultのフォルダ構成を実際に作成
- [x] テンプレートファイル（論点ノート・セッションログ・ソースマップ）を作成
- [x] Dataviewダッシュボード（99_ダッシュボード.md）を作成
- [x] Templater設定

### Phase 2: PDF取り込みパイプライン ✅
- [x] `ingest.sh` — STAGE 1+2 を統合実行するシェルスクリプト
- [x] `stage2.sh` — Claude Code によるノート生成（STAGE 2）
- [x] Gemini CLI用のプロンプトテンプレート
- [x] `01_sources/_index.json` の管理

### Phase 3: 演習連携 ✅
- [x] `log.sh` — 計算演習の結果記録（卒業保護・flock付き）
- [x] `komekome_writeback.sh` — コメコメ結果書き戻し（卒業判定・flock付き）
- [x] `generate_quiz.sh` — 出題リスト生成（卒業済み除外）
- [x] `anki_export.sh` — AnkiConnect API経由のカード追加（WSL2ホスト自動検出）

### Phase 4: 定期自動化 ✅
- [x] `cron_wrapper.sh` — ログ付きcronラッパー
- [x] cron ジョブの設定（毎朝7:00、毎週日曜6:00-6:30）
- [x] `weekly_report.sh` — 週次レポート生成
- [x] `notebooklm_export.sh` — NotebookLMエクスポート（6点改善済み: プレースホルダー除去・見出し正規化・A/Bフィルタ・SHA-256差分検出・wslview連携・500K文字分割）
- [x] `coverage_analysis.sh` — カバレッジ分析

### Phase 5: 品質最適化（Codex 5.3 レビュー） ✅

Phase 5.1〜5.3 で Codex 5.3 による多角的レビューを実施し、全スクリプトを横断的に改善。

#### Phase 5.1: 共通基盤整備
- [x] `lib/houjinzei_common.py` 共通モジュール新規作成（定数・frontmatter I/O・ユーティリティ）
- [x] `komekome_writeback.sh` に卒業保護ロジック追加（status=="卒業" のノートは更新しない）
- [x] stage 語彙統一: frontmatter の `stage` フィールド値を `卒業` → `卒業済` に変更
- [x] `generate_quiz.sh` / `coverage_analysis.sh` を正規表現パーサーから `yaml.safe_load` に移行
- [x] `generate_quiz.sh` に `flock` 追加

#### Phase 5.2: 全体最適化
- [x] `compute_stage()` / `normalize_stage()` を共通モジュールに追加（全スクリプト統一基準）
- [x] `topic_id` をパスベース形式（`損金算入/損金算入_交際費等_基本問題`）に統一
- [x] `log.sh` を `yaml.safe_load` に完全移行、stage 遷移を `kome_total` ベースに統一
- [x] `weekly_report.sh` の `parse_simple_yaml()` を削除、`normalize_stage()` に移行
- [x] `coverage_analysis.sh` に `normalize_stage()` と `flock` 追加
- [x] `log.sh` / `komekome_writeback.sh` に atomic write（`tempfile.mkstemp` + `os.replace`）追加

#### Phase 5.3: 最終品質監査
- [x] `komekome_writeback.sh`: `last_practiced` の `date` オブジェクト型を適切に処理
- [x] `coverage_analysis.sh`: `sources` orphan 検出の型安全性修正（list / str 両対応）
- [x] `notebooklm_export.sh`: `category` / `topic` の `NoneType` 対策
- [x] 全スクリプト: `README.md` / `CLAUDE.md` をスキャン対象から除外
- [x] `anki_export.sh` / `notebooklm_export.sh`: `errors="ignore"` 除去
- [x] `anki_export.sh`: 存在しないフィールド参照を実在フィールドに修正

#### Phase 5.4: 環境整備
- [x] `ingest.sh` / `stage2.sh`: unquoted heredoc → quoted heredoc + 環境変数パターンに統一
- [x] `.gitignore` に `docs/CLAUDE.md`（自動生成ファイル）を追加
- [x] cron デーモン自動起動設定（`/etc/wsl.conf` `[boot]` セクション）
- [x] `test_e2e.sh` E2Eシミュレーションテスト追加

### 自動化スクリプト一覧（~/scripts/）

| スクリプト | 概要 | 実行方法 |
|-----------|------|---------|
| `generate_quiz.sh` | 今日の出題リスト生成（間隔反復法） | cron 毎朝7:00 |
| `komekome_writeback.sh` | コメコメ結果→論点ノート書き戻し（卒業判定含む） | 手動 |
| `log.sh` | 計算演習の正誤記録 | 手動 |
| `anki_export.sh` | 卒業論点→Anki カード追加 | 手動 |
| `notebooklm_export.sh` | 論点→NotebookLM用Markdown | cron 毎週日曜6:30 |
| `weekly_report.sh` | 週次学習レポート | cron 毎週日曜6:00 |
| `coverage_analysis.sh` | 論点カバレッジ分析 | cron 毎週日曜6:15 |
| `cron_wrapper.sh` | cron用ログ付きラッパー | cron経由 |
| `ingest.sh` | PDF取り込みパイプライン | 手動 |
| `stage2.sh` | STAGE 2 ノート生成 | ingest.sh経由 |
| `test_e2e.sh` | E2Eシミュレーションテスト | 手動 |

### 共通モジュール（lib/houjinzei_common.py）

全スクリプトで共有する定数・関数を集約。

```python
# 定数
STAGE_VALUES = ("未着手", "学習中", "復習中", "卒業済")   # stage フィールドの許容値
STATUS_VALUES = ("未着手", "学習中", "復習中", "卒業")   # status フィールドの許容値
GRADUATION_GAP_DAYS = 25    # 卒業判定: 最終演習からの経過日数
GRADUATION_MIN_KOME = 4     # 卒業判定: 最低累積コメ数
KOME_THRESHOLD_REVIEW = 16  # kome_total >= 16 で stage=復習中

# 関数
compute_stage(status, kome_total, calc_correct, calc_wrong) → str  # stage 算出
normalize_stage(raw_stage, status) → str                           # stage 正規化（集計用）
read_frontmatter(md_path) → (dict, body_str)                      # yaml.safe_load ベース
write_frontmatter(md_path, data, body) → None                     # atomic write
```

### 技術パターン

| パターン | 適用 | 説明 |
|---------|------|------|
| Quoted heredoc | 全スクリプト | `<<'PY'` で shell 変数展開を防止、環境変数経由で値を渡す |
| yaml.safe_load | 全スクリプト | frontmatter パーサーを統一（正規表現パーサーは全廃） |
| flock | 全スクリプト | `/tmp/houjinzei_vault.lock` で並行実行を排他制御 |
| atomic write | log.sh, komekome_writeback.sh | `tempfile.mkstemp` + `os.replace` でデータ破損を防止 |
| 卒業保護 | log.sh, komekome_writeback.sh, generate_quiz.sh | `status=="卒業"` のノートは更新しない・出題しない |
| README/CLAUDE除外 | 全スクリプト | `10_論点/` 走査時に README.md, CLAUDE.md をスキップ |

---

## 13. 未決事項・検討中

- NotebookLMへのアップロード自動化（API非公開のため手動が残る。wslviewでブラウザを自動起動するまでは対応済み）
- コメコメアプリとObsidian間の同期方法の改善（現在はJSONファイル経由。GitHub Gist経由の自動同期を検討中）
- コメコメアプリ側の `intervalIndex` フィールド追加（卒業判定の精度向上。現在は last_practiced の日数差で暫定判定）
- 論点ノートの本文充実（52件が空テンプレート状態。PDF取り込みパイプラインで Gemini→Claude の2段階処理を実行する必要あり）
